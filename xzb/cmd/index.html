<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>账单查询系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vxe-pc-ui@4/lib/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vxe-table@4/lib/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/xe-utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/vxe-pc-ui@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/vxe-table@4"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vue-datepicker@1.0.0/dist/vue-datepicker.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue-datepicker@1.0.0/dist/vue-datepicker.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            margin-bottom: 20px;
            text-align: center;
        }
        .summary-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .card {
            flex: 1;
            min-width: 200px;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #666;
            font-size: 14px;
        }
        .card .value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        .card .income { color: #28a745; }
        .card .expense { color: #dc3545; }
        .card .net { color: #007bff; }
        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .filter-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-item {
            display: flex;
            flex-direction: column;
        }
        .filter-item label {
            font-size: 12px;
            margin-bottom: 4px;
            color: #666;
        }
        .filter-item input, .filter-item select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .filter-buttons button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        #tableContainer {
            margin-top: 20px;
        }
        /* 添加新的样式 */
        .date-range-buttons {
            display: flex;
            flex-direction: column;
            margin-left: 10px;
        }
        .date-range-buttons button {
            padding: 4px 8px;
            margin-bottom: 5px;
            border: none;
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: pointer;
        }
        .date-range-buttons button:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>账单查询系统</h1>
            </div>

            <div class="summary-cards">
                <div class="card">
                    <h3>总记录数</h3>
                    <div class="value">{{tableData.length}}</div>
                </div>
                <div class="card">
                    <h3>总收入</h3>
                    <div class="value income">+{{totalIncome.toFixed(2)}}</div>
                </div>
                <div class="card">
                    <h3>总支出</h3>
                    <div class="value expense">-{{totalExpense.toFixed(2)}}</div>
                </div>
                <div class="card">
                    <h3>净收入</h3>
                    <div class="value net" :class="{ 'income': netIncome >= 0, 'expense': netIncome < 0 }">
                        {{netIncome >= 0 ? '+' : ''}}{{netIncome.toFixed(2)}}
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-item">
                        <label>日期范围</label>
                        <input type="text" id="dateRange" placeholder="选择日期范围" />
                    </div>

                    <!-- 添加快捷按钮区域 -->
                    <div class="filter-item date-range-buttons">
                        <label>最近6个月</label>
                        <button @click="selectRecentMonths(0)">本月</button>
                        <button @click="selectRecentMonths(-1)">上月</button>
                        <button @click="selectRecentMonths(-2)">前2个月</button>
                        <button @click="selectRecentMonths(-3)">前3个月</button>
                        <button @click="selectRecentMonths(-4)">前4个月</button>
                        <button @click="selectRecentMonths(-5)">前5个月</button>
                    </div>

                    <div class="filter-item">
                        <label>分类</label>
                        <select v-model="filter.category">
                            <option value="">所有分类</option>
                            <option v-for="category in categories" :key="category" :value="category">
                                {{category}}
                            </option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>收支类型</label>
                        <select v-model="filter.inOut">
                            <option value="">所有类型</option>
                            <option value="收入">收入</option>
                            <option value="支出">支出</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>账户类型</label>
                        <select v-model="filter.accountType">
                            <option value="">所有账户</option>
                            <option value="微信">微信</option>
                            <option value="支付宝">支付宝</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>交易对方</label>
                        <input type="text" v-model="filter.counterparty" placeholder="支持模糊搜索">
                    </div>
                    <div class="filter-buttons">
                        <button class="btn-primary" @click="applyFilter">筛选</button>
                        <button class="btn-secondary" @click="clearFilter">清除</button>
                    </div>
                </div>
            </div>

            <!-- 移除表格容器高度限制 -->
            <div>
                <vxe-table
                    :data="tableData"
                    border
                    show-overflow
                    highlight-hover-row
                    ref="xTable"
                    :loading="loading">
                    <vxe-column field="Date" title="时间" width="160" sortable></vxe-column>
                    <vxe-column field="AccountType" title="账户" width="80" sortable></vxe-column>
                    <vxe-column field="Counterparty" title="交易对方" width="150"></vxe-column>
                    <vxe-column field="InOut" title="收支" width="80" sortable></vxe-column>
                    <vxe-column field="Amount" title="金额" width="100" sortable>
                        <template #default="{ row }">
                            <span :class="{ 'income': row.InOut === '收入', 'expense': row.InOut === '支出' }">
                                {{row.InOut === '收入' ? '+' : ''}}{{row.Amount.toFixed(2)}}
                            </span>
                        </template>
                    </vxe-column>
                    <vxe-column field="Category" title="分类" width="100"></vxe-column>
                    <vxe-column field="Remark" title="备注"></vxe-column>
                </vxe-table>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;

        const App = {
            setup() {
                const tableData = ref([]);
                const originalData = ref([]);
                const loading = ref(false);

                // 汇总数据
                const totalIncome = computed(() => {
                    return tableData.value
                        .filter(item => item.InOut === '收入')
                        .reduce((sum, item) => sum + item.Amount, 0);
                });

                const totalExpense = computed(() => {
                    return tableData.value
                        .filter(item => item.InOut === '支出')
                        .reduce((sum, item) => sum + item.Amount, 0);
                });

                const netIncome = computed(() => {
                    return totalIncome.value - totalExpense.value;
                });

                // 分类列表
                const categories = computed(() => {
                    const cats = [...new Set(originalData.value.map(item => item.Category))];
                    return cats.sort();
                });

                // 筛选条件
                const filter = reactive({
                    dateRange: [], // 替换原有的startDate和endDate
                    category: '',
                    inOut: '',
                    accountType: '',
                    counterparty: ''
                });

                // 新增：用于存储 flatpickr 实例
                let flatpickrInstance = null;

                // 初始化 flatpickr
                onMounted(() => {
                    flatpickrInstance = flatpickr("#dateRange", {
                        mode: "range",
                        dateFormat: "Y-m-d",
                        // 快捷选项配置
                        shortcuts: [
                            {
                                label: '本月',
                                dateFn: function() {
                                    const now = new Date();
                                    return [now, now];
                                }
                            },
                            {
                                label: '上月',
                                dateFn: function() {
                                    const lastMonth = new Date();
                                    lastMonth.setMonth(lastMonth.getMonth() - 1);
                                    return [lastMonth, lastMonth];
                                }
                            },
                            {
                                label: '前2个月',
                                dateFn: function() {
                                    const twoMonthsAgo = new Date();
                                    twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
                                    return [twoMonthsAgo, twoMonthsAgo];
                                }
                            },
                            {
                                label: '前3个月',
                                dateFn: function() {
                                    const threeMonthsAgo = new Date();
                                    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                                    return [threeMonthsAgo, threeMonthsAgo];
                                }
                            },
                            {
                                label: '前4个月',
                                dateFn: function() {
                                    const fourMonthsAgo = new Date();
                                    fourMonthsAgo.setMonth(fourMonthsAgo.getMonth() - 4);
                                    return [fourMonthsAgo, fourMonthsAgo];
                                }
                            },
                            {
                                label: '前5个月',
                                dateFn: function() {
                                    const fiveMonthsAgo = new Date();
                                    fiveMonthsAgo.setMonth(fiveMonthsAgo.getMonth() - 5);
                                    return [fiveMonthsAgo, fiveMonthsAgo];
                                }
                            },
                            {
                                label: '最近6个月',
                                dateFn: function() {
                                    const sixMonthsAgo = new Date();
                                    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                                    return [sixMonthsAgo, new Date()];
                                }
                            }
                        ],
                        // 选择日期后触发筛选
                        onChange: function(selectedDates, dateStr, instance) {
                            if (selectedDates.length === 2) {
                                filter.dateRange = [
                                    selectedDates[0].toISOString().split('T')[0],
                                    selectedDates[1].toISOString().split('T')[0]
                                ];
                                applyFilter();
                            }
                        }
                    });
                });

                // 新增方法：选择最近几个月
                const selectRecentMonths = (monthsAgo) => {
                    const today = new Date();
                    const start = new Date(today.getFullYear(), today.getMonth() + monthsAgo, 1);
                    const end = new Date(today.getFullYear(), today.getMonth() + monthsAgo + 1, 0);
                    filter.dateRange = [start.toISOString().split('T')[0], end.toISOString().split('T')[0]];
                    // 触发 flatpickr 更新
                    if (flatpickrInstance) {
                        flatpickrInstance.setDate([start, end]);
                    }
                };

                // 获取所有数据
                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const response = await fetch('/api/bills');
                        const data = await response.json();
                        tableData.value = data;
                        originalData.value = data;
                    } catch (error) {
                        console.error('获取数据失败:', error);
                    } finally {
                        loading.value = false;
                    }
                };

                // 应用筛选
                const applyFilter = async () => {
                    loading.value = true;
                    try {
                        let url = '/api/bills?';
                        if (filter.dateRange && filter.dateRange.length === 2) {
                            url += 'start_date=' + filter.dateRange[0] + '&end_date=' + filter.dateRange[1] + '&';
                        }
                        if (filter.category) url += 'category=' + encodeURIComponent(filter.category) + '&';
                        if (filter.inOut) url += 'in_out=' + encodeURIComponent(filter.inOut) + '&';
                        if (filter.accountType) url += 'account_type=' + encodeURIComponent(filter.accountType) + '&';
                        if (filter.counterparty) url += 'counterparty=' + encodeURIComponent(filter.counterparty) + '&';

                        // 移除末尾的 &
                        if (url.endsWith('&')) {
                            url = url.slice(0, -1);
                        }

                        const response = await fetch(url);
                        const data = await response.json();
                        tableData.value = data;
                    } catch (error) {
                        console.error('筛选数据失败:', error);
                    } finally {
                        loading.value = false;
                    }
                };

                // 清除筛选
                const clearFilter = () => {
                    filter.dateRange = [];
                    filter.category = '';
                    filter.inOut = '';
                    filter.accountType = '';
                    filter.counterparty = '';
                    tableData.value = [...originalData.value];
                    // 重置 flatpickr
                    if (flatpickrInstance) {
                        flatpickrInstance.clear();
                    }
                };

                // 初始化
                onMounted(() => {
                    fetchData();
                });

                return {
                    tableData,
                    originalData,
                    loading,
                    totalIncome,
                    totalExpense,
                    netIncome,
                    categories,
                    filter,
                    applyFilter,
                    clearFilter,
                    selectRecentMonths
                };
            }
        };

        createApp(App)
            .use(VxeUI)
            .use(VXETable)
            .mount('#app');
    </script>
</body>
</html>
